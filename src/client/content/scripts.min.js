var board = (function() {

   var $board = $("#board");
   var $board_header = $("#board_header");
   var $new_game = $("#new_game");

   const HEIGHT = 9;
   const WIDTH = 9;

   var board;

   var $selected = null;

   const typeNames = [
      'empty',
      'attacker',
      'defender',
      'king'
   ];

   function onClick() {
      var $cell = $(this);
      var type = $cell.attr('class');

      if(type == "attacker") {
         if($selected) {
            $selected.attr('class','attacker');
            $selected = null;
         }
         else {
            $cell.attr('class','attacker-select');
            $selected = $cell;
         }
      }
      else if($selected){
         if(type == "empty") {
            var result = google_apis.player_move(
               $selected.attr('id'),
               $cell.attr('id')
            );
         }
         else {
            $selected.attr('class','attacker');
            $selected = null;
         }
      }
   }
   function new_game() {
      $board.on('click','.row > div > div', onClick);
      google_apis.new_game();
      $board_header.hide();
   }
   $new_game.on('click',new_game);

   function cellClick(target, params) {

   }

   function game_end(game_state) {
      if(game_state == 2 || game_state == 3) {
         if(game_state == 2){
            $board_header.append("Player won!");
            $board_header.addClass("attacker-header");
         }
         else {
             $board_header.addClass("defender-header");
             $board_header.append("AI won!");
          }
         $board.off();
         $board_header.removeClass('hidden');
         return true;
      }
      return false;
   }

   function empty_board() {

      $board = $("#board");
      var table_builder = "";
   	for(var row=0; row< HEIGHT; row++){
         var row_builder = "<div class='row'>";
   		for(var col=0; col< WIDTH; col++) {
            row_builder += "<div><div data-val='0' class='empty' id='" + row + "," + col + "'></div></div>";
   		}
         row_builder += "</div>";

         table_builder += row_builder;
   	}

      $board.append(table_builder);

      $board.on('click','.row > div > div', onClick);

   }

   function fadeInNewClass(source, from_class, to_class) {
      source.switchClass(from_class, to_class, 1000);
   }

   function move(origin_value, origin, destination, captures) {

      $selected.attr('class','attacker');
      $selected = null;

      var or = document.getElementById(origin);
      var $or = $(or);
      $or.attr('class',typeNames[0]);

      var de = document.getElementById(destination);
      var $de = $(de);
      $de.attr('class',typeNames[origin_value]);

      if(captures && captures[0]) {

         for(var i=0; i< captures.length; i++) {
            f = captures[i][0];
            t = captures[i][1];
            var ca = document.getElementById(f + "," + t);
            var $ca = $(ca);
            $ca.attr('class',typeNames[0]);
         }
      }
   }

   function new_board(board) {
      board = board;
   	for(var row=0; row < board.length; row++){
         var columnWidth = board[row].length;
   		for(var col=0; col < columnWidth; col++) {
            var val = board[row][col];

               var t = document.getElementById(row + "," + col);

               var $cell = $(t);

               $cell.attr('class',typeNames[val]);

   		}
   	}

   }

   function make_move(from_r, from_c, to_r, to_c, captures, value) {

      board[from_r][from_c] = 0;
      board[to_r][to_c] = value;
      $("#" + from_r + "," + from_c).attr('class','empty');
      $("#" + to_r + "," + to_c).attr('class',typeNames[value]);
      for(var capture in captures) {
         var r = capture[0];
         var c = capture[1];
         board[r][c] = 0;
         $("#" + r + "," + c).attr('class','empty');
      }

   }

   return {
      empty_board: empty_board,
      new_board: new_board,
      move: move,
      game_end: game_end
   };
})();

var dialogs = (function(){

   var $how = $("#how");
   var $history = $("#history");
   var $about = $("#about");

   var how_dialog = document.getElementById('how-dialog');
   var history_dialog = document.getElementById('history-dialog');
   var about_dialog = document.getElementById('about-dialog');

   function openHow(){
      how_dialog.showModal();
   }

   function openHistory() {
      history_dialog.showModal();
   }

   function openAbout() {
      about_dialog.showModal();
   }

   function closeHow() {
      how_dialog.close();
   }

   function closeHistory() {
      history_dialog.close();
   }

   function closeAbout() {
      about_dialog.close();
   }

   $how.on('click', openHow);
   $history.on('click', openHistory);
   $about.on('click', openAbout);

   how_dialog.querySelector('.close').addEventListener('click', closeHow);
   history_dialog.querySelector('.close').addEventListener('click', closeHistory);
   about_dialog.querySelector('.close').addEventListener('click', closeAbout);

})();

var google_apis = (function() {

   var KEY = null;

   function new_game() {
      gapi.client.hnefatafl.new_game().execute(function(response){
         KEY = response.key;
         board.new_board(JSON.parse(response.board));
         ai_move();
      });
   }

   function last_player_game() {

      gapi.client.hnefatafl.last_player_game().execute(function(response){
         if(response.code == 404) {
            new_game();
         }
         else {
            KEY = response.key;
            board.new_board(JSON.parse(response.board));
            var state = parseInt(response.state);
            if(!board.game_end(state))
               if(state == 1) ai_move();
         }
      });
   }

   function player_move(origin, destination) {
      var origins = origin.split(',');
      var destinations = destination.split(',');

      try
      {
         gapi.client.hnefatafl.player_move({
            "game_key": KEY,
            "origin_row": origins[0],
            "origin_column": origins[1],
            "destination_row": destinations[0],
            "destination_column": destinations[1]
         }).execute(function(response){

            board.move(
               response.origin_value,
               response.origin,
               response.destination,
               response.captures != "[]" ?
               JSON.parse(
                  response.captures.replace('(','[').replace(')',']')
               ): null
            );
            if(!board.game_end(parseInt(response.game_state))) {
               ai_move();
            }

         });
      }
      catch(err) {

      }
   }

      function ai_move() {
         gapi.client.hnefatafl.ai_move({
            "game_key":KEY
         }).execute(function(response){
            board.move(
               response.origin_value,
               response.origin,
               response.destination,
               response.captures != "[]" ?
               JSON.parse(
                  response.captures.replace('(','[').replace(')',']')
               ): null
            );
            board.game_end(parseInt(response.game_state));
         });
      }
      return {
         new_game: new_game,
         player_move: player_move,
         ai_move: ai_move,
         last_player_game: last_player_game
      };
})();

var google_auth = (function(){

   const url = "http://localhost:8080/_ah/api";
   var signedin = false;

   function loadModules(){
      gapi.client.load(
         'oauth2',
         'v2'
      );
      gapi.client.load(
         'hnefatafl',
         'v1',
         afterLoaded,
         url
      );
   }

   function afterLoaded() {
      signin(immediate = true);
      setTimeout(profile.enableLogin(), 2000);

   }

   function signin(immediate) {
      gapi.auth.authorize({
         client_id: '314272160250-ucrqg44c1oj9knlrfatqvqf1b3pm9819.apps.googleusercontent.com',
         scope: 'https://www.googleapis.com/auth/userinfo.email',
         immediate: immediate
      }, userAuthed);
   }

   function isAuthed() {
      return signedin;
   }

   function userAuthed(mode) {
      var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
         if (!resp.code) {
            profile.setLoggedIn(resp.picture, resp.name);
            signedin = true;
            //google_apis.new_game(google_apis.ai_move);
            google_apis.last_player_game();
         //   google_apis.ai_move();
          }
     });
   }
   return {
      loadModules: loadModules,
      isAuthed: isAuthed,
      signin: signin
   };

})();

var profile = (function() {
   var $login = $("#login");
   //var $picture = $("#picture");
   var $name = $("#name");

   function enableLogin() {
      $login.on('click', _loginClick);
      $login.removeClass("hidden");
   }
   function _loginClick() {
      google_auth.signin(immediate = false);
   }
   function _logoutClick() {
      //singin(immediate = false);
   }
   function setLoggedIn(src, name) {
      $name.html(name);
      $name.removeClass("hidden");
      $login.addClass("hidden");
   }
   return {
      enableLogin: enableLogin,
      setLoggedIn: setLoggedIn
   };
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJvYXJkLmpzIiwiZGlhbG9ncy5qcyIsImdvb2dsZV9hcGkuanMiLCJnb29nbGVfYXV0aC5qcyIsInByb2ZpbGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEtBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3JGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3REQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InNjcmlwdHMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJvYXJkID0gKGZ1bmN0aW9uKCkge1xuXG4gICB2YXIgJGJvYXJkID0gJChcIiNib2FyZFwiKTtcbiAgIHZhciAkYm9hcmRfaGVhZGVyID0gJChcIiNib2FyZF9oZWFkZXJcIik7XG4gICB2YXIgJG5ld19nYW1lID0gJChcIiNuZXdfZ2FtZVwiKTtcblxuICAgY29uc3QgSEVJR0hUID0gOTtcbiAgIGNvbnN0IFdJRFRIID0gOTtcblxuICAgdmFyIGJvYXJkO1xuXG4gICB2YXIgJHNlbGVjdGVkID0gbnVsbDtcblxuICAgY29uc3QgdHlwZU5hbWVzID0gW1xuICAgICAgJ2VtcHR5JyxcbiAgICAgICdhdHRhY2tlcicsXG4gICAgICAnZGVmZW5kZXInLFxuICAgICAgJ2tpbmcnXG4gICBdO1xuXG4gICBmdW5jdGlvbiBvbkNsaWNrKCkge1xuICAgICAgdmFyICRjZWxsID0gJCh0aGlzKTtcbiAgICAgIHZhciB0eXBlID0gJGNlbGwuYXR0cignY2xhc3MnKTtcblxuICAgICAgaWYodHlwZSA9PSBcImF0dGFja2VyXCIpIHtcbiAgICAgICAgIGlmKCRzZWxlY3RlZCkge1xuICAgICAgICAgICAgJHNlbGVjdGVkLmF0dHIoJ2NsYXNzJywnYXR0YWNrZXInKTtcbiAgICAgICAgICAgICRzZWxlY3RlZCA9IG51bGw7XG4gICAgICAgICB9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICRjZWxsLmF0dHIoJ2NsYXNzJywnYXR0YWNrZXItc2VsZWN0Jyk7XG4gICAgICAgICAgICAkc2VsZWN0ZWQgPSAkY2VsbDtcbiAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2UgaWYoJHNlbGVjdGVkKXtcbiAgICAgICAgIGlmKHR5cGUgPT0gXCJlbXB0eVwiKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gZ29vZ2xlX2FwaXMucGxheWVyX21vdmUoXG4gICAgICAgICAgICAgICAkc2VsZWN0ZWQuYXR0cignaWQnKSxcbiAgICAgICAgICAgICAgICRjZWxsLmF0dHIoJ2lkJylcbiAgICAgICAgICAgICk7XG4gICAgICAgICB9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICRzZWxlY3RlZC5hdHRyKCdjbGFzcycsJ2F0dGFja2VyJyk7XG4gICAgICAgICAgICAkc2VsZWN0ZWQgPSBudWxsO1xuICAgICAgICAgfVxuICAgICAgfVxuICAgfVxuICAgZnVuY3Rpb24gbmV3X2dhbWUoKSB7XG4gICAgICAkYm9hcmQub24oJ2NsaWNrJywnLnJvdyA+IGRpdiA+IGRpdicsIG9uQ2xpY2spO1xuICAgICAgZ29vZ2xlX2FwaXMubmV3X2dhbWUoKTtcbiAgICAgICRib2FyZF9oZWFkZXIuaGlkZSgpO1xuICAgfVxuICAgJG5ld19nYW1lLm9uKCdjbGljaycsbmV3X2dhbWUpO1xuXG4gICBmdW5jdGlvbiBjZWxsQ2xpY2sodGFyZ2V0LCBwYXJhbXMpIHtcblxuICAgfVxuXG4gICBmdW5jdGlvbiBnYW1lX2VuZChnYW1lX3N0YXRlKSB7XG4gICAgICBpZihnYW1lX3N0YXRlID09IDIgfHwgZ2FtZV9zdGF0ZSA9PSAzKSB7XG4gICAgICAgICBpZihnYW1lX3N0YXRlID09IDIpe1xuICAgICAgICAgICAgJGJvYXJkX2hlYWRlci5hcHBlbmQoXCJQbGF5ZXIgd29uIVwiKTtcbiAgICAgICAgICAgICRib2FyZF9oZWFkZXIuYWRkQ2xhc3MoXCJhdHRhY2tlci1oZWFkZXJcIik7XG4gICAgICAgICB9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAkYm9hcmRfaGVhZGVyLmFkZENsYXNzKFwiZGVmZW5kZXItaGVhZGVyXCIpO1xuICAgICAgICAgICAgICRib2FyZF9oZWFkZXIuYXBwZW5kKFwiQUkgd29uIVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgICAkYm9hcmQub2ZmKCk7XG4gICAgICAgICAkYm9hcmRfaGVhZGVyLnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcbiAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgfVxuXG4gICBmdW5jdGlvbiBlbXB0eV9ib2FyZCgpIHtcblxuICAgICAgJGJvYXJkID0gJChcIiNib2FyZFwiKTtcbiAgICAgIHZhciB0YWJsZV9idWlsZGVyID0gXCJcIjtcbiAgIFx0Zm9yKHZhciByb3c9MDsgcm93PCBIRUlHSFQ7IHJvdysrKXtcbiAgICAgICAgIHZhciByb3dfYnVpbGRlciA9IFwiPGRpdiBjbGFzcz0ncm93Jz5cIjtcbiAgIFx0XHRmb3IodmFyIGNvbD0wOyBjb2w8IFdJRFRIOyBjb2wrKykge1xuICAgICAgICAgICAgcm93X2J1aWxkZXIgKz0gXCI8ZGl2PjxkaXYgZGF0YS12YWw9JzAnIGNsYXNzPSdlbXB0eScgaWQ9J1wiICsgcm93ICsgXCIsXCIgKyBjb2wgKyBcIic+PC9kaXY+PC9kaXY+XCI7XG4gICBcdFx0fVxuICAgICAgICAgcm93X2J1aWxkZXIgKz0gXCI8L2Rpdj5cIjtcblxuICAgICAgICAgdGFibGVfYnVpbGRlciArPSByb3dfYnVpbGRlcjtcbiAgIFx0fVxuXG4gICAgICAkYm9hcmQuYXBwZW5kKHRhYmxlX2J1aWxkZXIpO1xuXG4gICAgICAkYm9hcmQub24oJ2NsaWNrJywnLnJvdyA+IGRpdiA+IGRpdicsIG9uQ2xpY2spO1xuXG4gICB9XG5cbiAgIGZ1bmN0aW9uIGZhZGVJbk5ld0NsYXNzKHNvdXJjZSwgZnJvbV9jbGFzcywgdG9fY2xhc3MpIHtcbiAgICAgIHNvdXJjZS5zd2l0Y2hDbGFzcyhmcm9tX2NsYXNzLCB0b19jbGFzcywgMTAwMCk7XG4gICB9XG5cbiAgIGZ1bmN0aW9uIG1vdmUob3JpZ2luX3ZhbHVlLCBvcmlnaW4sIGRlc3RpbmF0aW9uLCBjYXB0dXJlcykge1xuXG4gICAgICAkc2VsZWN0ZWQuYXR0cignY2xhc3MnLCdhdHRhY2tlcicpO1xuICAgICAgJHNlbGVjdGVkID0gbnVsbDtcblxuICAgICAgdmFyIG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQob3JpZ2luKTtcbiAgICAgIHZhciAkb3IgPSAkKG9yKTtcbiAgICAgICRvci5hdHRyKCdjbGFzcycsdHlwZU5hbWVzWzBdKTtcblxuICAgICAgdmFyIGRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVzdGluYXRpb24pO1xuICAgICAgdmFyICRkZSA9ICQoZGUpO1xuICAgICAgJGRlLmF0dHIoJ2NsYXNzJyx0eXBlTmFtZXNbb3JpZ2luX3ZhbHVlXSk7XG5cbiAgICAgIGlmKGNhcHR1cmVzICYmIGNhcHR1cmVzWzBdKSB7XG5cbiAgICAgICAgIGZvcih2YXIgaT0wOyBpPCBjYXB0dXJlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgZiA9IGNhcHR1cmVzW2ldWzBdO1xuICAgICAgICAgICAgdCA9IGNhcHR1cmVzW2ldWzFdO1xuICAgICAgICAgICAgdmFyIGNhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZiArIFwiLFwiICsgdCk7XG4gICAgICAgICAgICB2YXIgJGNhID0gJChjYSk7XG4gICAgICAgICAgICAkY2EuYXR0cignY2xhc3MnLHR5cGVOYW1lc1swXSk7XG4gICAgICAgICB9XG4gICAgICB9XG4gICB9XG5cbiAgIGZ1bmN0aW9uIG5ld19ib2FyZChib2FyZCkge1xuICAgICAgYm9hcmQgPSBib2FyZDtcbiAgIFx0Zm9yKHZhciByb3c9MDsgcm93IDwgYm9hcmQubGVuZ3RoOyByb3crKyl7XG4gICAgICAgICB2YXIgY29sdW1uV2lkdGggPSBib2FyZFtyb3ddLmxlbmd0aDtcbiAgIFx0XHRmb3IodmFyIGNvbD0wOyBjb2wgPCBjb2x1bW5XaWR0aDsgY29sKyspIHtcbiAgICAgICAgICAgIHZhciB2YWwgPSBib2FyZFtyb3ddW2NvbF07XG5cbiAgICAgICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocm93ICsgXCIsXCIgKyBjb2wpO1xuXG4gICAgICAgICAgICAgICB2YXIgJGNlbGwgPSAkKHQpO1xuXG4gICAgICAgICAgICAgICAkY2VsbC5hdHRyKCdjbGFzcycsdHlwZU5hbWVzW3ZhbF0pO1xuXG4gICBcdFx0fVxuICAgXHR9XG5cbiAgIH1cblxuICAgZnVuY3Rpb24gbWFrZV9tb3ZlKGZyb21fciwgZnJvbV9jLCB0b19yLCB0b19jLCBjYXB0dXJlcywgdmFsdWUpIHtcblxuICAgICAgYm9hcmRbZnJvbV9yXVtmcm9tX2NdID0gMDtcbiAgICAgIGJvYXJkW3RvX3JdW3RvX2NdID0gdmFsdWU7XG4gICAgICAkKFwiI1wiICsgZnJvbV9yICsgXCIsXCIgKyBmcm9tX2MpLmF0dHIoJ2NsYXNzJywnZW1wdHknKTtcbiAgICAgICQoXCIjXCIgKyB0b19yICsgXCIsXCIgKyB0b19jKS5hdHRyKCdjbGFzcycsdHlwZU5hbWVzW3ZhbHVlXSk7XG4gICAgICBmb3IodmFyIGNhcHR1cmUgaW4gY2FwdHVyZXMpIHtcbiAgICAgICAgIHZhciByID0gY2FwdHVyZVswXTtcbiAgICAgICAgIHZhciBjID0gY2FwdHVyZVsxXTtcbiAgICAgICAgIGJvYXJkW3JdW2NdID0gMDtcbiAgICAgICAgICQoXCIjXCIgKyByICsgXCIsXCIgKyBjKS5hdHRyKCdjbGFzcycsJ2VtcHR5Jyk7XG4gICAgICB9XG5cbiAgIH1cblxuICAgcmV0dXJuIHtcbiAgICAgIGVtcHR5X2JvYXJkOiBlbXB0eV9ib2FyZCxcbiAgICAgIG5ld19ib2FyZDogbmV3X2JvYXJkLFxuICAgICAgbW92ZTogbW92ZSxcbiAgICAgIGdhbWVfZW5kOiBnYW1lX2VuZFxuICAgfTtcbn0pKCk7XG4iLCJ2YXIgZGlhbG9ncyA9IChmdW5jdGlvbigpe1xuXG4gICB2YXIgJGhvdyA9ICQoXCIjaG93XCIpO1xuICAgdmFyICRoaXN0b3J5ID0gJChcIiNoaXN0b3J5XCIpO1xuICAgdmFyICRhYm91dCA9ICQoXCIjYWJvdXRcIik7XG5cbiAgIHZhciBob3dfZGlhbG9nID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hvdy1kaWFsb2cnKTtcbiAgIHZhciBoaXN0b3J5X2RpYWxvZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaXN0b3J5LWRpYWxvZycpO1xuICAgdmFyIGFib3V0X2RpYWxvZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhYm91dC1kaWFsb2cnKTtcblxuICAgZnVuY3Rpb24gb3Blbkhvdygpe1xuICAgICAgaG93X2RpYWxvZy5zaG93TW9kYWwoKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gb3Blbkhpc3RvcnkoKSB7XG4gICAgICBoaXN0b3J5X2RpYWxvZy5zaG93TW9kYWwoKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gb3BlbkFib3V0KCkge1xuICAgICAgYWJvdXRfZGlhbG9nLnNob3dNb2RhbCgpO1xuICAgfVxuXG4gICBmdW5jdGlvbiBjbG9zZUhvdygpIHtcbiAgICAgIGhvd19kaWFsb2cuY2xvc2UoKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gY2xvc2VIaXN0b3J5KCkge1xuICAgICAgaGlzdG9yeV9kaWFsb2cuY2xvc2UoKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gY2xvc2VBYm91dCgpIHtcbiAgICAgIGFib3V0X2RpYWxvZy5jbG9zZSgpO1xuICAgfVxuXG4gICAkaG93Lm9uKCdjbGljaycsIG9wZW5Ib3cpO1xuICAgJGhpc3Rvcnkub24oJ2NsaWNrJywgb3Blbkhpc3RvcnkpO1xuICAgJGFib3V0Lm9uKCdjbGljaycsIG9wZW5BYm91dCk7XG5cbiAgIGhvd19kaWFsb2cucXVlcnlTZWxlY3RvcignLmNsb3NlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjbG9zZUhvdyk7XG4gICBoaXN0b3J5X2RpYWxvZy5xdWVyeVNlbGVjdG9yKCcuY2xvc2UnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGNsb3NlSGlzdG9yeSk7XG4gICBhYm91dF9kaWFsb2cucXVlcnlTZWxlY3RvcignLmNsb3NlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBjbG9zZUFib3V0KTtcblxufSkoKTtcbiIsInZhciBnb29nbGVfYXBpcyA9IChmdW5jdGlvbigpIHtcblxuICAgdmFyIEtFWSA9IG51bGw7XG5cbiAgIGZ1bmN0aW9uIG5ld19nYW1lKCkge1xuICAgICAgZ2FwaS5jbGllbnQuaG5lZmF0YWZsLm5ld19nYW1lKCkuZXhlY3V0ZShmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICBLRVkgPSByZXNwb25zZS5rZXk7XG4gICAgICAgICBib2FyZC5uZXdfYm9hcmQoSlNPTi5wYXJzZShyZXNwb25zZS5ib2FyZCkpO1xuICAgICAgICAgYWlfbW92ZSgpO1xuICAgICAgfSk7XG4gICB9XG5cbiAgIGZ1bmN0aW9uIGxhc3RfcGxheWVyX2dhbWUoKSB7XG5cbiAgICAgIGdhcGkuY2xpZW50LmhuZWZhdGFmbC5sYXN0X3BsYXllcl9nYW1lKCkuZXhlY3V0ZShmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICBpZihyZXNwb25zZS5jb2RlID09IDQwNCkge1xuICAgICAgICAgICAgbmV3X2dhbWUoKTtcbiAgICAgICAgIH1cbiAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgS0VZID0gcmVzcG9uc2Uua2V5O1xuICAgICAgICAgICAgYm9hcmQubmV3X2JvYXJkKEpTT04ucGFyc2UocmVzcG9uc2UuYm9hcmQpKTtcbiAgICAgICAgICAgIHZhciBzdGF0ZSA9IHBhcnNlSW50KHJlc3BvbnNlLnN0YXRlKTtcbiAgICAgICAgICAgIGlmKCFib2FyZC5nYW1lX2VuZChzdGF0ZSkpXG4gICAgICAgICAgICAgICBpZihzdGF0ZSA9PSAxKSBhaV9tb3ZlKCk7XG4gICAgICAgICB9XG4gICAgICB9KTtcbiAgIH1cblxuICAgZnVuY3Rpb24gcGxheWVyX21vdmUob3JpZ2luLCBkZXN0aW5hdGlvbikge1xuICAgICAgdmFyIG9yaWdpbnMgPSBvcmlnaW4uc3BsaXQoJywnKTtcbiAgICAgIHZhciBkZXN0aW5hdGlvbnMgPSBkZXN0aW5hdGlvbi5zcGxpdCgnLCcpO1xuXG4gICAgICB0cnlcbiAgICAgIHtcbiAgICAgICAgIGdhcGkuY2xpZW50LmhuZWZhdGFmbC5wbGF5ZXJfbW92ZSh7XG4gICAgICAgICAgICBcImdhbWVfa2V5XCI6IEtFWSxcbiAgICAgICAgICAgIFwib3JpZ2luX3Jvd1wiOiBvcmlnaW5zWzBdLFxuICAgICAgICAgICAgXCJvcmlnaW5fY29sdW1uXCI6IG9yaWdpbnNbMV0sXG4gICAgICAgICAgICBcImRlc3RpbmF0aW9uX3Jvd1wiOiBkZXN0aW5hdGlvbnNbMF0sXG4gICAgICAgICAgICBcImRlc3RpbmF0aW9uX2NvbHVtblwiOiBkZXN0aW5hdGlvbnNbMV1cbiAgICAgICAgIH0pLmV4ZWN1dGUoZnVuY3Rpb24ocmVzcG9uc2Upe1xuXG4gICAgICAgICAgICBib2FyZC5tb3ZlKFxuICAgICAgICAgICAgICAgcmVzcG9uc2Uub3JpZ2luX3ZhbHVlLFxuICAgICAgICAgICAgICAgcmVzcG9uc2Uub3JpZ2luLFxuICAgICAgICAgICAgICAgcmVzcG9uc2UuZGVzdGluYXRpb24sXG4gICAgICAgICAgICAgICByZXNwb25zZS5jYXB0dXJlcyAhPSBcIltdXCIgP1xuICAgICAgICAgICAgICAgSlNPTi5wYXJzZShcbiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmNhcHR1cmVzLnJlcGxhY2UoJygnLCdbJykucmVwbGFjZSgnKScsJ10nKVxuICAgICAgICAgICAgICAgKTogbnVsbFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmKCFib2FyZC5nYW1lX2VuZChwYXJzZUludChyZXNwb25zZS5nYW1lX3N0YXRlKSkpIHtcbiAgICAgICAgICAgICAgIGFpX21vdmUoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjYXRjaChlcnIpIHtcblxuICAgICAgfVxuICAgfVxuXG4gICAgICBmdW5jdGlvbiBhaV9tb3ZlKCkge1xuICAgICAgICAgZ2FwaS5jbGllbnQuaG5lZmF0YWZsLmFpX21vdmUoe1xuICAgICAgICAgICAgXCJnYW1lX2tleVwiOktFWVxuICAgICAgICAgfSkuZXhlY3V0ZShmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgICAgICBib2FyZC5tb3ZlKFxuICAgICAgICAgICAgICAgcmVzcG9uc2Uub3JpZ2luX3ZhbHVlLFxuICAgICAgICAgICAgICAgcmVzcG9uc2Uub3JpZ2luLFxuICAgICAgICAgICAgICAgcmVzcG9uc2UuZGVzdGluYXRpb24sXG4gICAgICAgICAgICAgICByZXNwb25zZS5jYXB0dXJlcyAhPSBcIltdXCIgP1xuICAgICAgICAgICAgICAgSlNPTi5wYXJzZShcbiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmNhcHR1cmVzLnJlcGxhY2UoJygnLCdbJykucmVwbGFjZSgnKScsJ10nKVxuICAgICAgICAgICAgICAgKTogbnVsbFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGJvYXJkLmdhbWVfZW5kKHBhcnNlSW50KHJlc3BvbnNlLmdhbWVfc3RhdGUpKTtcbiAgICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgIG5ld19nYW1lOiBuZXdfZ2FtZSxcbiAgICAgICAgIHBsYXllcl9tb3ZlOiBwbGF5ZXJfbW92ZSxcbiAgICAgICAgIGFpX21vdmU6IGFpX21vdmUsXG4gICAgICAgICBsYXN0X3BsYXllcl9nYW1lOiBsYXN0X3BsYXllcl9nYW1lXG4gICAgICB9O1xufSkoKTtcbiIsInZhciBnb29nbGVfYXV0aCA9IChmdW5jdGlvbigpe1xuXG4gICBjb25zdCB1cmwgPSBcImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9fYWgvYXBpXCI7XG4gICB2YXIgc2lnbmVkaW4gPSBmYWxzZTtcblxuICAgZnVuY3Rpb24gbG9hZE1vZHVsZXMoKXtcbiAgICAgIGdhcGkuY2xpZW50LmxvYWQoXG4gICAgICAgICAnb2F1dGgyJyxcbiAgICAgICAgICd2MidcbiAgICAgICk7XG4gICAgICBnYXBpLmNsaWVudC5sb2FkKFxuICAgICAgICAgJ2huZWZhdGFmbCcsXG4gICAgICAgICAndjEnLFxuICAgICAgICAgYWZ0ZXJMb2FkZWQsXG4gICAgICAgICB1cmxcbiAgICAgICk7XG4gICB9XG5cbiAgIGZ1bmN0aW9uIGFmdGVyTG9hZGVkKCkge1xuICAgICAgc2lnbmluKGltbWVkaWF0ZSA9IHRydWUpO1xuICAgICAgc2V0VGltZW91dChwcm9maWxlLmVuYWJsZUxvZ2luKCksIDIwMDApO1xuXG4gICB9XG5cbiAgIGZ1bmN0aW9uIHNpZ25pbihpbW1lZGlhdGUpIHtcbiAgICAgIGdhcGkuYXV0aC5hdXRob3JpemUoe1xuICAgICAgICAgY2xpZW50X2lkOiAnMzE0MjcyMTYwMjUwLXVjcnFnNDRjMW9qOWtubHJmYXRxdnFmMWIzcG05ODE5LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tJyxcbiAgICAgICAgIHNjb3BlOiAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC91c2VyaW5mby5lbWFpbCcsXG4gICAgICAgICBpbW1lZGlhdGU6IGltbWVkaWF0ZVxuICAgICAgfSwgdXNlckF1dGhlZCk7XG4gICB9XG5cbiAgIGZ1bmN0aW9uIGlzQXV0aGVkKCkge1xuICAgICAgcmV0dXJuIHNpZ25lZGluO1xuICAgfVxuXG4gICBmdW5jdGlvbiB1c2VyQXV0aGVkKG1vZGUpIHtcbiAgICAgIHZhciByZXF1ZXN0ID0gZ2FwaS5jbGllbnQub2F1dGgyLnVzZXJpbmZvLmdldCgpLmV4ZWN1dGUoZnVuY3Rpb24ocmVzcCkge1xuICAgICAgICAgaWYgKCFyZXNwLmNvZGUpIHtcbiAgICAgICAgICAgIHByb2ZpbGUuc2V0TG9nZ2VkSW4ocmVzcC5waWN0dXJlLCByZXNwLm5hbWUpO1xuICAgICAgICAgICAgc2lnbmVkaW4gPSB0cnVlO1xuICAgICAgICAgICAgLy9nb29nbGVfYXBpcy5uZXdfZ2FtZShnb29nbGVfYXBpcy5haV9tb3ZlKTtcbiAgICAgICAgICAgIGdvb2dsZV9hcGlzLmxhc3RfcGxheWVyX2dhbWUoKTtcbiAgICAgICAgIC8vICAgZ29vZ2xlX2FwaXMuYWlfbW92ZSgpO1xuICAgICAgICAgIH1cbiAgICAgfSk7XG4gICB9XG4gICByZXR1cm4ge1xuICAgICAgbG9hZE1vZHVsZXM6IGxvYWRNb2R1bGVzLFxuICAgICAgaXNBdXRoZWQ6IGlzQXV0aGVkLFxuICAgICAgc2lnbmluOiBzaWduaW5cbiAgIH07XG5cbn0pKCk7XG4iLCJ2YXIgcHJvZmlsZSA9IChmdW5jdGlvbigpIHtcbiAgIHZhciAkbG9naW4gPSAkKFwiI2xvZ2luXCIpO1xuICAgLy92YXIgJHBpY3R1cmUgPSAkKFwiI3BpY3R1cmVcIik7XG4gICB2YXIgJG5hbWUgPSAkKFwiI25hbWVcIik7XG5cbiAgIGZ1bmN0aW9uIGVuYWJsZUxvZ2luKCkge1xuICAgICAgJGxvZ2luLm9uKCdjbGljaycsIF9sb2dpbkNsaWNrKTtcbiAgICAgICRsb2dpbi5yZW1vdmVDbGFzcyhcImhpZGRlblwiKTtcbiAgIH1cbiAgIGZ1bmN0aW9uIF9sb2dpbkNsaWNrKCkge1xuICAgICAgZ29vZ2xlX2F1dGguc2lnbmluKGltbWVkaWF0ZSA9IGZhbHNlKTtcbiAgIH1cbiAgIGZ1bmN0aW9uIF9sb2dvdXRDbGljaygpIHtcbiAgICAgIC8vc2luZ2luKGltbWVkaWF0ZSA9IGZhbHNlKTtcbiAgIH1cbiAgIGZ1bmN0aW9uIHNldExvZ2dlZEluKHNyYywgbmFtZSkge1xuICAgICAgJG5hbWUuaHRtbChuYW1lKTtcbiAgICAgICRuYW1lLnJlbW92ZUNsYXNzKFwiaGlkZGVuXCIpO1xuICAgICAgJGxvZ2luLmFkZENsYXNzKFwiaGlkZGVuXCIpO1xuICAgfVxuICAgcmV0dXJuIHtcbiAgICAgIGVuYWJsZUxvZ2luOiBlbmFibGVMb2dpbixcbiAgICAgIHNldExvZ2dlZEluOiBzZXRMb2dnZWRJblxuICAgfTtcbn0pKCk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
