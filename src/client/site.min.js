var board = (function() {

   var $board = $("#board");
   let $board_header = $("#board_header");
   let $new_game = $("#new_game");

   const HEIGHT = 9;
   const WIDTH = 9;

   var board;

   var $selected = null;

   const typeNames = [
      'empty',
      'attacker',
      'defender',
      'king'
   ];

   function onClick() {
      var $cell = $(this);
      var type = $cell.attr('class');

      if(type == "attacker") {
         if($selected) {
            $selected.attr('class','attacker');
            $selected = null;
         }
         else {
            $cell.attr('class','attacker-select');
            $selected = $cell;
         }
      }
      else if($selected){
         if(type == "empty") {
            google_apis.player_move(
               $selected.attr('id'),
               $cell.attr('id')
            )
            $selected = null;
         }
         else {
            $selected.attr('class','attacker');
            $selected = null;
         }
      }
   }
   function new_game() {
         $board.on('click','.row > div > div', onClick);
      google_apis.new_game();
      $board_header.hide();
   }
   $new_game.on('click',new_game);
   function cellClick(target, params) {

   }

   function game_end(game_state) {
      if(game_state == 2 || game_state == 3) {
         if(game_state == 2){
            $board_header.append("Player won!")
            $board_header.addClass("attacker-header");
         }
         else {
             $board_header.addClass("defender-header");
             $board_header.append("AI won!");
          }
         $board.off();
         $board_header.removeClass('hidden');
         return true;
      }
      return false;
   }

   function empty_board() {

      $board = $("#board");
      var table_builder = "";
   	for(var row=0; row< HEIGHT; row++){
         var row_builder = "<div class='row'>";
   		for(var col=0; col< WIDTH; col++) {
            row_builder += "<div><div data-val='0' class='empty' id='" + row + "," + col + "'></div></div>";
   		}
         row_builder += "</div>";

         table_builder += row_builder;
   	}

      $board.append(table_builder);

      $board.on('click','.row > div > div', onClick);

   }

   function fadeInNewClass(source, from_class, to_class) {
      source.switchClass(from_class, to_class, 1000);
   }

   function move(origin_value, origin, destination, captures) {
      var or = document.getElementById(origin);
      var $or = $(or);
      $or.attr('class',typeNames[0]);

      var de = document.getElementById(destination);
      var $de = $(de);
      $de.attr('class',typeNames[origin_value]);

      if(captures && captures[0]) {

         for(var i=0; i< captures.length; i++) {
            f = captures[i][0];
            t = captures[i][1];
            console.log(f);
            var ca = document.getElementById(f + "," + t);
            var $ca = $(ca);
            $ca.attr('class',typeNames[0]);
         }
      }
   }

   function new_board(board) {
      board = board;
   	for(var row=0; row < board.length; row++){
         var columnWidth = board[row].length;
   		for(var col=0; col < columnWidth; col++) {
            var val = board[row][col];

               var t = document.getElementById(row + "," + col);

               var $cell = $(t);

               $cell.attr('class',typeNames[val]);

   		}
   	}

   }

   function make_move(from_r, from_c, to_r, to_c, captures, value) {

      board[from_r][from_c] = 0;
      board[to_r][to_c] = value;
      $("#" + from_r + "," + from_c).attr('class','empty');
      $("#" + to_r + "," + to_c).attr('class',typeNames[value]);
      for(var capture in captures) {
         var r = capture[0];
         var c = capture[1];
         board[r][c] = 0;
         $("#" + r + "," + c).attr('class','empty');
      }

   }

         return {empty_board , new_board , move, game_end};
})();

//
// function change_board() {
// 	for(var row=0; row< BOARD.length; row++){
// 		for(var col=0; col< BOARD[row].length; col++) {
//
// 			var val = BOARD[row][col];
// 			var rect = document.getElementById(row + ',' + col);
//
// 			if(val == '0') cls = 'empty';
// 			else if(val == '1') cls = 'attacker';
// 			else if(val == '2') cls = 'defender';
// 			else if(val == '3') cls = 'king';
// 			rect.setAttribute('class',cls);
// 		}
// 	}
// }
//
//
//
// $(function() {
//
//
// 	var from_cell = null;
//
// 	$("body").on("click","rect",function(){
//
// 		var cls = $(this).attr('class');
// 		//console.log(cls);
// 		//console.log(from_cell);
// 		if (cls == "empty" && from_cell != null) {
//
// 			var to_cell = $(this).attr('id').split(',');
// 			to_cell[0] = parseInt(to_cell[0]);
// 			to_cell[1] = parseInt(to_cell[1]);
//
// 			if (from_cell[0] == to_cell[0]) {
// 				console.log(from_cell);		// same row
// 				if(from_cell[1] < to_cell[1]) {				// goes right
// 					x = from_cell[1] + 1;
// 					console.log(x);
// 					while(x <= to_cell[1]) {
// 						console.log(x);
// 						if(BOARD[from_cell[0]][x] != 0) {
// 							return clear();
// 						}
// 						x++;
// 					}
// 				}
// 				else if(from_cell[1] > to_cell[1]) {		// goes left
// 					x = from_cell[1] - 1;
// 					while(x >= to_cell[1]) {
// 						if(BOARD[from_cell[0]][x] != 0) {
// 							return clear();
// 						}
// 						x--;
// 					}
// 				}
// 				else return clear();
// 			}
// 			else if (from_cell[1] == to_cell[1]) {		// same column
// 				if(from_cell[0] > to_cell[0]) {				// goes up
// 					y = from_cell[0] + 1;
// 					while(y <= to_cell[0]) {
// 						if(BOARD[y][cell[1]] != 0) {
// 							return clear();
// 						}
// 						y++;
// 					}
// 				}
// 				else if(from_cell[0] < to_cell[0]) {		// goes down
// 					y = from_cell[0] - 1;
// 					while(y >= to_cell[0]) {
// 						if(BOARD[y][cell[1]] != 0) {
// 							return clear();
// 						}
// 						y--;
// 					}
// 				}
// 				else return clear();
// 			}
// 			else return clear();
// 			api_player_move(from_cell.join(','), $(this).attr('id'));
// 			clear();
// 		}
// 		else if (cls == "attacker" && from_cell == null) {
// 			from_cell = $(this).attr('id').split(',');
// 			from_cell[0] = parseInt(from_cell[0]);
// 			from_cell[1] = parseInt(from_cell[1]);
// 			$(this).attr('class','attacker-select');
// 		}
// 		else clear();
// 	});
//
// 	function clear() {
// 		if(from_cell != null) document.getElementById(from_cell[0] + ',' + from_cell[1]).setAttribute('class',"attacker");
// 		from_cell = null;
// 	}
// });

var google_apis = (function() {

   var KEY = null;

   function new_game() {
      gapi.client.hnefatafl.new_game().execute(function(response){
         KEY = response.key;
         board.new_board(JSON.parse(response.board));
         ai_move();
      });
   }

   function last_player_game() {

      gapi.client.hnefatafl.last_player_game().execute(function(response){
         console.log(response);
         if(response.code == 404) {
            new_game();
         }
         else {
            KEY = response.key;
            board.new_board(JSON.parse(response.board));
            var state = parseInt(response.state);
            if(!board.game_end(state))
               if(state == 1) ai_move();
         }
      });
   }

   function player_move(origin, destination) {
      var origins = origin.split(',');
      var destinations = destination.split(',');

      gapi.client.hnefatafl.player_move({
         "game_key": KEY,
         "origin_row": origins[0],
         "origin_column": origins[1],
         "destination_row": destinations[0],
         "destination_column": destinations[1]
      }).execute(function(response){
         console.log(response);
         board.move(
            response.origin_value,
            response.origin,
            response.destination,
            response.captures != "[]" ?
            JSON.parse(
               response.captures.replace('(','[').replace(')',']')
            ): null
         );
         if(!board.game_end(parseInt(response.game_state))) {
            ai_move();
         }
      });
   }

      function ai_move() {
         gapi.client.hnefatafl.ai_move({
            "game_key":KEY
         }).execute(function(response){
            console.log(response);
            board.move(
               response.origin_value,
               response.origin,
               response.destination,
               response.captures != "[]" ?
               JSON.parse(
                  response.captures.replace('(','[').replace(')',']')
               ): null
            );
            board.game_end(parseInt(response.game_state));
         });
      }
      return {new_game, player_move, ai_move, last_player_game};
})();

var google_auth = (function(){

   const url = 'http://localhost:8080/_ah/api';
   var signedin = false;

   function loadModules(){
      gapi.client.load(
         'oauth2',
         'v2'
      );
      gapi.client.load(
         'hnefatafl',
         'v1',
         afterLoaded,
         url
      );
   }

   function afterLoaded() {
      signin(immediate = true);
      setTimeout(profile.enableLogin(), 2000);

   }

   function signin(immediate) {
      gapi.auth.authorize({
         client_id: '314272160250-ucrqg44c1oj9knlrfatqvqf1b3pm9819.apps.googleusercontent.com',
         scope: 'https://www.googleapis.com/auth/userinfo.email',
         immediate: immediate
      }, userAuthed);
   }

   function isAuthed() {
      return signedin;
   }

   function userAuthed(mode) {
      var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
         if (!resp.code) {
            profile.setLoggedIn(resp.picture, resp.name);
            signedin = true;
            //google_apis.new_game(google_apis.ai_move);
            google_apis.last_player_game();
         //   google_apis.ai_move();
          }
     });
   }
   return {
      loadModules: loadModules,
      isAuthed: isAuthed,
      signin: signin
   };

})();

var profile = (function() {
   var $login = $("#login");
   //var $picture = $("#picture");
   var $name = $("#name");

   function enableLogin() {
      $login.on('click', _loginClick);
      console.log('enabled');
      $login.removeClass("hidden");
   }
   function _loginClick() {
      console.log('clik');
      google_auth.signin(immediate = false);
   }
   function _logoutClick() {
      //singin(immediate = false);
   }
   function setLoggedIn(src, name) {
      console.log(name);
   //   enableLogin();
   //   $picture.attr('src', src);
     $name.html(name);
        $name.removeClass("hidden");
      $login.addClass("hidden");
   //   $btn.addClass("alert");
   ////   $btn.off('click');
   //   $btn.on('click', _logoutClick);
   }
   return {
      enableLogin: enableLogin,
      setLoggedIn: setLoggedIn
   };
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJvYXJkLmpzIiwiZ29vZ2xlX2FwaS5qcyIsImdvb2dsZV9hdXRoLmpzIiwicHJvZmlsZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9QQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3REQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzaXRlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBib2FyZCA9IChmdW5jdGlvbigpIHtcblxuICAgbGV0ICRib2FyZCA9ICQoXCIjYm9hcmRcIik7XG4gICBsZXQgJGJvYXJkX2hlYWRlciA9ICQoXCIjYm9hcmRfaGVhZGVyXCIpO1xuICAgbGV0ICRuZXdfZ2FtZSA9ICQoXCIjbmV3X2dhbWVcIik7XG5cbiAgIGNvbnN0IEhFSUdIVCA9IDk7XG4gICBjb25zdCBXSURUSCA9IDk7XG5cbiAgIHZhciBib2FyZDtcblxuICAgdmFyICRzZWxlY3RlZCA9IG51bGw7XG5cbiAgIGNvbnN0IHR5cGVOYW1lcyA9IFtcbiAgICAgICdlbXB0eScsXG4gICAgICAnYXR0YWNrZXInLFxuICAgICAgJ2RlZmVuZGVyJyxcbiAgICAgICdraW5nJ1xuICAgXTtcblxuICAgZnVuY3Rpb24gb25DbGljaygpIHtcbiAgICAgIHZhciAkY2VsbCA9ICQodGhpcyk7XG4gICAgICB2YXIgdHlwZSA9ICRjZWxsLmF0dHIoJ2NsYXNzJyk7XG5cbiAgICAgIGlmKHR5cGUgPT0gXCJhdHRhY2tlclwiKSB7XG4gICAgICAgICBpZigkc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICRzZWxlY3RlZC5hdHRyKCdjbGFzcycsJ2F0dGFja2VyJyk7XG4gICAgICAgICAgICAkc2VsZWN0ZWQgPSBudWxsO1xuICAgICAgICAgfVxuICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAkY2VsbC5hdHRyKCdjbGFzcycsJ2F0dGFja2VyLXNlbGVjdCcpO1xuICAgICAgICAgICAgJHNlbGVjdGVkID0gJGNlbGw7XG4gICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIGlmKCRzZWxlY3RlZCl7XG4gICAgICAgICBpZih0eXBlID09IFwiZW1wdHlcIikge1xuICAgICAgICAgICAgZ29vZ2xlX2FwaXMucGxheWVyX21vdmUoXG4gICAgICAgICAgICAgICAkc2VsZWN0ZWQuYXR0cignaWQnKSxcbiAgICAgICAgICAgICAgICRjZWxsLmF0dHIoJ2lkJylcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgICRzZWxlY3RlZCA9IG51bGw7XG4gICAgICAgICB9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICRzZWxlY3RlZC5hdHRyKCdjbGFzcycsJ2F0dGFja2VyJyk7XG4gICAgICAgICAgICAkc2VsZWN0ZWQgPSBudWxsO1xuICAgICAgICAgfVxuICAgICAgfVxuICAgfVxuICAgZnVuY3Rpb24gbmV3X2dhbWUoKSB7XG4gICAgICAgICAkYm9hcmQub24oJ2NsaWNrJywnLnJvdyA+IGRpdiA+IGRpdicsIG9uQ2xpY2spO1xuICAgICAgZ29vZ2xlX2FwaXMubmV3X2dhbWUoKTtcbiAgICAgICRib2FyZF9oZWFkZXIuaGlkZSgpO1xuICAgfVxuICAgJG5ld19nYW1lLm9uKCdjbGljaycsbmV3X2dhbWUpO1xuICAgZnVuY3Rpb24gY2VsbENsaWNrKHRhcmdldCwgcGFyYW1zKSB7XG5cbiAgIH1cblxuICAgZnVuY3Rpb24gZ2FtZV9lbmQoZ2FtZV9zdGF0ZSkge1xuICAgICAgaWYoZ2FtZV9zdGF0ZSA9PSAyIHx8IGdhbWVfc3RhdGUgPT0gMykge1xuICAgICAgICAgaWYoZ2FtZV9zdGF0ZSA9PSAyKXtcbiAgICAgICAgICAgICRib2FyZF9oZWFkZXIuYXBwZW5kKFwiUGxheWVyIHdvbiFcIilcbiAgICAgICAgICAgICRib2FyZF9oZWFkZXIuYWRkQ2xhc3MoXCJhdHRhY2tlci1oZWFkZXJcIik7XG4gICAgICAgICB9XG4gICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAkYm9hcmRfaGVhZGVyLmFkZENsYXNzKFwiZGVmZW5kZXItaGVhZGVyXCIpO1xuICAgICAgICAgICAgICRib2FyZF9oZWFkZXIuYXBwZW5kKFwiQUkgd29uIVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgICAkYm9hcmQub2ZmKCk7XG4gICAgICAgICAkYm9hcmRfaGVhZGVyLnJlbW92ZUNsYXNzKCdoaWRkZW4nKTtcbiAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgfVxuXG4gICBmdW5jdGlvbiBlbXB0eV9ib2FyZCgpIHtcblxuICAgICAgJGJvYXJkID0gJChcIiNib2FyZFwiKTtcbiAgICAgIHZhciB0YWJsZV9idWlsZGVyID0gXCJcIjtcbiAgIFx0Zm9yKHZhciByb3c9MDsgcm93PCBIRUlHSFQ7IHJvdysrKXtcbiAgICAgICAgIHZhciByb3dfYnVpbGRlciA9IFwiPGRpdiBjbGFzcz0ncm93Jz5cIjtcbiAgIFx0XHRmb3IodmFyIGNvbD0wOyBjb2w8IFdJRFRIOyBjb2wrKykge1xuICAgICAgICAgICAgcm93X2J1aWxkZXIgKz0gXCI8ZGl2PjxkaXYgZGF0YS12YWw9JzAnIGNsYXNzPSdlbXB0eScgaWQ9J1wiICsgcm93ICsgXCIsXCIgKyBjb2wgKyBcIic+PC9kaXY+PC9kaXY+XCI7XG4gICBcdFx0fVxuICAgICAgICAgcm93X2J1aWxkZXIgKz0gXCI8L2Rpdj5cIjtcblxuICAgICAgICAgdGFibGVfYnVpbGRlciArPSByb3dfYnVpbGRlcjtcbiAgIFx0fVxuXG4gICAgICAkYm9hcmQuYXBwZW5kKHRhYmxlX2J1aWxkZXIpO1xuXG4gICAgICAkYm9hcmQub24oJ2NsaWNrJywnLnJvdyA+IGRpdiA+IGRpdicsIG9uQ2xpY2spO1xuXG4gICB9XG5cbiAgIGZ1bmN0aW9uIGZhZGVJbk5ld0NsYXNzKHNvdXJjZSwgZnJvbV9jbGFzcywgdG9fY2xhc3MpIHtcbiAgICAgIHNvdXJjZS5zd2l0Y2hDbGFzcyhmcm9tX2NsYXNzLCB0b19jbGFzcywgMTAwMCk7XG4gICB9XG5cbiAgIGZ1bmN0aW9uIG1vdmUob3JpZ2luX3ZhbHVlLCBvcmlnaW4sIGRlc3RpbmF0aW9uLCBjYXB0dXJlcykge1xuICAgICAgdmFyIG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQob3JpZ2luKTtcbiAgICAgIHZhciAkb3IgPSAkKG9yKTtcbiAgICAgICRvci5hdHRyKCdjbGFzcycsdHlwZU5hbWVzWzBdKTtcblxuICAgICAgdmFyIGRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGVzdGluYXRpb24pO1xuICAgICAgdmFyICRkZSA9ICQoZGUpO1xuICAgICAgJGRlLmF0dHIoJ2NsYXNzJyx0eXBlTmFtZXNbb3JpZ2luX3ZhbHVlXSk7XG5cbiAgICAgIGlmKGNhcHR1cmVzICYmIGNhcHR1cmVzWzBdKSB7XG5cbiAgICAgICAgIGZvcih2YXIgaT0wOyBpPCBjYXB0dXJlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgZiA9IGNhcHR1cmVzW2ldWzBdO1xuICAgICAgICAgICAgdCA9IGNhcHR1cmVzW2ldWzFdO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZik7XG4gICAgICAgICAgICB2YXIgY2EgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmICsgXCIsXCIgKyB0KTtcbiAgICAgICAgICAgIHZhciAkY2EgPSAkKGNhKTtcbiAgICAgICAgICAgICRjYS5hdHRyKCdjbGFzcycsdHlwZU5hbWVzWzBdKTtcbiAgICAgICAgIH1cbiAgICAgIH1cbiAgIH1cblxuICAgZnVuY3Rpb24gbmV3X2JvYXJkKGJvYXJkKSB7XG4gICAgICBib2FyZCA9IGJvYXJkO1xuICAgXHRmb3IodmFyIHJvdz0wOyByb3cgPCBib2FyZC5sZW5ndGg7IHJvdysrKXtcbiAgICAgICAgIHZhciBjb2x1bW5XaWR0aCA9IGJvYXJkW3Jvd10ubGVuZ3RoO1xuICAgXHRcdGZvcih2YXIgY29sPTA7IGNvbCA8IGNvbHVtbldpZHRoOyBjb2wrKykge1xuICAgICAgICAgICAgdmFyIHZhbCA9IGJvYXJkW3Jvd11bY29sXTtcblxuICAgICAgICAgICAgICAgdmFyIHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChyb3cgKyBcIixcIiArIGNvbCk7XG5cbiAgICAgICAgICAgICAgIHZhciAkY2VsbCA9ICQodCk7XG5cbiAgICAgICAgICAgICAgICRjZWxsLmF0dHIoJ2NsYXNzJyx0eXBlTmFtZXNbdmFsXSk7XG5cbiAgIFx0XHR9XG4gICBcdH1cblxuICAgfVxuXG4gICBmdW5jdGlvbiBtYWtlX21vdmUoZnJvbV9yLCBmcm9tX2MsIHRvX3IsIHRvX2MsIGNhcHR1cmVzLCB2YWx1ZSkge1xuXG4gICAgICBib2FyZFtmcm9tX3JdW2Zyb21fY10gPSAwO1xuICAgICAgYm9hcmRbdG9fcl1bdG9fY10gPSB2YWx1ZTtcbiAgICAgICQoXCIjXCIgKyBmcm9tX3IgKyBcIixcIiArIGZyb21fYykuYXR0cignY2xhc3MnLCdlbXB0eScpO1xuICAgICAgJChcIiNcIiArIHRvX3IgKyBcIixcIiArIHRvX2MpLmF0dHIoJ2NsYXNzJyx0eXBlTmFtZXNbdmFsdWVdKTtcbiAgICAgIGZvcih2YXIgY2FwdHVyZSBpbiBjYXB0dXJlcykge1xuICAgICAgICAgdmFyIHIgPSBjYXB0dXJlWzBdO1xuICAgICAgICAgdmFyIGMgPSBjYXB0dXJlWzFdO1xuICAgICAgICAgYm9hcmRbcl1bY10gPSAwO1xuICAgICAgICAgJChcIiNcIiArIHIgKyBcIixcIiArIGMpLmF0dHIoJ2NsYXNzJywnZW1wdHknKTtcbiAgICAgIH1cblxuICAgfVxuXG4gICAgICAgICByZXR1cm4ge2VtcHR5X2JvYXJkICwgbmV3X2JvYXJkICwgbW92ZSwgZ2FtZV9lbmR9O1xufSkoKTtcblxuLy9cbi8vIGZ1bmN0aW9uIGNoYW5nZV9ib2FyZCgpIHtcbi8vIFx0Zm9yKHZhciByb3c9MDsgcm93PCBCT0FSRC5sZW5ndGg7IHJvdysrKXtcbi8vIFx0XHRmb3IodmFyIGNvbD0wOyBjb2w8IEJPQVJEW3Jvd10ubGVuZ3RoOyBjb2wrKykge1xuLy9cbi8vIFx0XHRcdHZhciB2YWwgPSBCT0FSRFtyb3ddW2NvbF07XG4vLyBcdFx0XHR2YXIgcmVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJvdyArICcsJyArIGNvbCk7XG4vL1xuLy8gXHRcdFx0aWYodmFsID09ICcwJykgY2xzID0gJ2VtcHR5Jztcbi8vIFx0XHRcdGVsc2UgaWYodmFsID09ICcxJykgY2xzID0gJ2F0dGFja2VyJztcbi8vIFx0XHRcdGVsc2UgaWYodmFsID09ICcyJykgY2xzID0gJ2RlZmVuZGVyJztcbi8vIFx0XHRcdGVsc2UgaWYodmFsID09ICczJykgY2xzID0gJ2tpbmcnO1xuLy8gXHRcdFx0cmVjdC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJyxjbHMpO1xuLy8gXHRcdH1cbi8vIFx0fVxuLy8gfVxuLy9cbi8vXG4vL1xuLy8gJChmdW5jdGlvbigpIHtcbi8vXG4vL1xuLy8gXHR2YXIgZnJvbV9jZWxsID0gbnVsbDtcbi8vXG4vLyBcdCQoXCJib2R5XCIpLm9uKFwiY2xpY2tcIixcInJlY3RcIixmdW5jdGlvbigpe1xuLy9cbi8vIFx0XHR2YXIgY2xzID0gJCh0aGlzKS5hdHRyKCdjbGFzcycpO1xuLy8gXHRcdC8vY29uc29sZS5sb2coY2xzKTtcbi8vIFx0XHQvL2NvbnNvbGUubG9nKGZyb21fY2VsbCk7XG4vLyBcdFx0aWYgKGNscyA9PSBcImVtcHR5XCIgJiYgZnJvbV9jZWxsICE9IG51bGwpIHtcbi8vXG4vLyBcdFx0XHR2YXIgdG9fY2VsbCA9ICQodGhpcykuYXR0cignaWQnKS5zcGxpdCgnLCcpO1xuLy8gXHRcdFx0dG9fY2VsbFswXSA9IHBhcnNlSW50KHRvX2NlbGxbMF0pO1xuLy8gXHRcdFx0dG9fY2VsbFsxXSA9IHBhcnNlSW50KHRvX2NlbGxbMV0pO1xuLy9cbi8vIFx0XHRcdGlmIChmcm9tX2NlbGxbMF0gPT0gdG9fY2VsbFswXSkge1xuLy8gXHRcdFx0XHRjb25zb2xlLmxvZyhmcm9tX2NlbGwpO1x0XHQvLyBzYW1lIHJvd1xuLy8gXHRcdFx0XHRpZihmcm9tX2NlbGxbMV0gPCB0b19jZWxsWzFdKSB7XHRcdFx0XHQvLyBnb2VzIHJpZ2h0XG4vLyBcdFx0XHRcdFx0eCA9IGZyb21fY2VsbFsxXSArIDE7XG4vLyBcdFx0XHRcdFx0Y29uc29sZS5sb2coeCk7XG4vLyBcdFx0XHRcdFx0d2hpbGUoeCA8PSB0b19jZWxsWzFdKSB7XG4vLyBcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyh4KTtcbi8vIFx0XHRcdFx0XHRcdGlmKEJPQVJEW2Zyb21fY2VsbFswXV1beF0gIT0gMCkge1xuLy8gXHRcdFx0XHRcdFx0XHRyZXR1cm4gY2xlYXIoKTtcbi8vIFx0XHRcdFx0XHRcdH1cbi8vIFx0XHRcdFx0XHRcdHgrKztcbi8vIFx0XHRcdFx0XHR9XG4vLyBcdFx0XHRcdH1cbi8vIFx0XHRcdFx0ZWxzZSBpZihmcm9tX2NlbGxbMV0gPiB0b19jZWxsWzFdKSB7XHRcdC8vIGdvZXMgbGVmdFxuLy8gXHRcdFx0XHRcdHggPSBmcm9tX2NlbGxbMV0gLSAxO1xuLy8gXHRcdFx0XHRcdHdoaWxlKHggPj0gdG9fY2VsbFsxXSkge1xuLy8gXHRcdFx0XHRcdFx0aWYoQk9BUkRbZnJvbV9jZWxsWzBdXVt4XSAhPSAwKSB7XG4vLyBcdFx0XHRcdFx0XHRcdHJldHVybiBjbGVhcigpO1xuLy8gXHRcdFx0XHRcdFx0fVxuLy8gXHRcdFx0XHRcdFx0eC0tO1xuLy8gXHRcdFx0XHRcdH1cbi8vIFx0XHRcdFx0fVxuLy8gXHRcdFx0XHRlbHNlIHJldHVybiBjbGVhcigpO1xuLy8gXHRcdFx0fVxuLy8gXHRcdFx0ZWxzZSBpZiAoZnJvbV9jZWxsWzFdID09IHRvX2NlbGxbMV0pIHtcdFx0Ly8gc2FtZSBjb2x1bW5cbi8vIFx0XHRcdFx0aWYoZnJvbV9jZWxsWzBdID4gdG9fY2VsbFswXSkge1x0XHRcdFx0Ly8gZ29lcyB1cFxuLy8gXHRcdFx0XHRcdHkgPSBmcm9tX2NlbGxbMF0gKyAxO1xuLy8gXHRcdFx0XHRcdHdoaWxlKHkgPD0gdG9fY2VsbFswXSkge1xuLy8gXHRcdFx0XHRcdFx0aWYoQk9BUkRbeV1bY2VsbFsxXV0gIT0gMCkge1xuLy8gXHRcdFx0XHRcdFx0XHRyZXR1cm4gY2xlYXIoKTtcbi8vIFx0XHRcdFx0XHRcdH1cbi8vIFx0XHRcdFx0XHRcdHkrKztcbi8vIFx0XHRcdFx0XHR9XG4vLyBcdFx0XHRcdH1cbi8vIFx0XHRcdFx0ZWxzZSBpZihmcm9tX2NlbGxbMF0gPCB0b19jZWxsWzBdKSB7XHRcdC8vIGdvZXMgZG93blxuLy8gXHRcdFx0XHRcdHkgPSBmcm9tX2NlbGxbMF0gLSAxO1xuLy8gXHRcdFx0XHRcdHdoaWxlKHkgPj0gdG9fY2VsbFswXSkge1xuLy8gXHRcdFx0XHRcdFx0aWYoQk9BUkRbeV1bY2VsbFsxXV0gIT0gMCkge1xuLy8gXHRcdFx0XHRcdFx0XHRyZXR1cm4gY2xlYXIoKTtcbi8vIFx0XHRcdFx0XHRcdH1cbi8vIFx0XHRcdFx0XHRcdHktLTtcbi8vIFx0XHRcdFx0XHR9XG4vLyBcdFx0XHRcdH1cbi8vIFx0XHRcdFx0ZWxzZSByZXR1cm4gY2xlYXIoKTtcbi8vIFx0XHRcdH1cbi8vIFx0XHRcdGVsc2UgcmV0dXJuIGNsZWFyKCk7XG4vLyBcdFx0XHRhcGlfcGxheWVyX21vdmUoZnJvbV9jZWxsLmpvaW4oJywnKSwgJCh0aGlzKS5hdHRyKCdpZCcpKTtcbi8vIFx0XHRcdGNsZWFyKCk7XG4vLyBcdFx0fVxuLy8gXHRcdGVsc2UgaWYgKGNscyA9PSBcImF0dGFja2VyXCIgJiYgZnJvbV9jZWxsID09IG51bGwpIHtcbi8vIFx0XHRcdGZyb21fY2VsbCA9ICQodGhpcykuYXR0cignaWQnKS5zcGxpdCgnLCcpO1xuLy8gXHRcdFx0ZnJvbV9jZWxsWzBdID0gcGFyc2VJbnQoZnJvbV9jZWxsWzBdKTtcbi8vIFx0XHRcdGZyb21fY2VsbFsxXSA9IHBhcnNlSW50KGZyb21fY2VsbFsxXSk7XG4vLyBcdFx0XHQkKHRoaXMpLmF0dHIoJ2NsYXNzJywnYXR0YWNrZXItc2VsZWN0Jyk7XG4vLyBcdFx0fVxuLy8gXHRcdGVsc2UgY2xlYXIoKTtcbi8vIFx0fSk7XG4vL1xuLy8gXHRmdW5jdGlvbiBjbGVhcigpIHtcbi8vIFx0XHRpZihmcm9tX2NlbGwgIT0gbnVsbCkgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZnJvbV9jZWxsWzBdICsgJywnICsgZnJvbV9jZWxsWzFdKS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJyxcImF0dGFja2VyXCIpO1xuLy8gXHRcdGZyb21fY2VsbCA9IG51bGw7XG4vLyBcdH1cbi8vIH0pO1xuIiwidmFyIGdvb2dsZV9hcGlzID0gKGZ1bmN0aW9uKCkge1xuXG4gICB2YXIgS0VZID0gbnVsbDtcblxuICAgZnVuY3Rpb24gbmV3X2dhbWUoKSB7XG4gICAgICBnYXBpLmNsaWVudC5obmVmYXRhZmwubmV3X2dhbWUoKS5leGVjdXRlKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgIEtFWSA9IHJlc3BvbnNlLmtleTtcbiAgICAgICAgIGJvYXJkLm5ld19ib2FyZChKU09OLnBhcnNlKHJlc3BvbnNlLmJvYXJkKSk7XG4gICAgICAgICBhaV9tb3ZlKCk7XG4gICAgICB9KTtcbiAgIH1cblxuICAgZnVuY3Rpb24gbGFzdF9wbGF5ZXJfZ2FtZSgpIHtcblxuICAgICAgZ2FwaS5jbGllbnQuaG5lZmF0YWZsLmxhc3RfcGxheWVyX2dhbWUoKS5leGVjdXRlKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcbiAgICAgICAgIGlmKHJlc3BvbnNlLmNvZGUgPT0gNDA0KSB7XG4gICAgICAgICAgICBuZXdfZ2FtZSgpO1xuICAgICAgICAgfVxuICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBLRVkgPSByZXNwb25zZS5rZXk7XG4gICAgICAgICAgICBib2FyZC5uZXdfYm9hcmQoSlNPTi5wYXJzZShyZXNwb25zZS5ib2FyZCkpO1xuICAgICAgICAgICAgdmFyIHN0YXRlID0gcGFyc2VJbnQocmVzcG9uc2Uuc3RhdGUpO1xuICAgICAgICAgICAgaWYoIWJvYXJkLmdhbWVfZW5kKHN0YXRlKSlcbiAgICAgICAgICAgICAgIGlmKHN0YXRlID09IDEpIGFpX21vdmUoKTtcbiAgICAgICAgIH1cbiAgICAgIH0pO1xuICAgfVxuXG4gICBmdW5jdGlvbiBwbGF5ZXJfbW92ZShvcmlnaW4sIGRlc3RpbmF0aW9uKSB7XG4gICAgICB2YXIgb3JpZ2lucyA9IG9yaWdpbi5zcGxpdCgnLCcpO1xuICAgICAgdmFyIGRlc3RpbmF0aW9ucyA9IGRlc3RpbmF0aW9uLnNwbGl0KCcsJyk7XG5cbiAgICAgIGdhcGkuY2xpZW50LmhuZWZhdGFmbC5wbGF5ZXJfbW92ZSh7XG4gICAgICAgICBcImdhbWVfa2V5XCI6IEtFWSxcbiAgICAgICAgIFwib3JpZ2luX3Jvd1wiOiBvcmlnaW5zWzBdLFxuICAgICAgICAgXCJvcmlnaW5fY29sdW1uXCI6IG9yaWdpbnNbMV0sXG4gICAgICAgICBcImRlc3RpbmF0aW9uX3Jvd1wiOiBkZXN0aW5hdGlvbnNbMF0sXG4gICAgICAgICBcImRlc3RpbmF0aW9uX2NvbHVtblwiOiBkZXN0aW5hdGlvbnNbMV1cbiAgICAgIH0pLmV4ZWN1dGUoZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICAgYm9hcmQubW92ZShcbiAgICAgICAgICAgIHJlc3BvbnNlLm9yaWdpbl92YWx1ZSxcbiAgICAgICAgICAgIHJlc3BvbnNlLm9yaWdpbixcbiAgICAgICAgICAgIHJlc3BvbnNlLmRlc3RpbmF0aW9uLFxuICAgICAgICAgICAgcmVzcG9uc2UuY2FwdHVyZXMgIT0gXCJbXVwiID9cbiAgICAgICAgICAgIEpTT04ucGFyc2UoXG4gICAgICAgICAgICAgICByZXNwb25zZS5jYXB0dXJlcy5yZXBsYWNlKCcoJywnWycpLnJlcGxhY2UoJyknLCddJylcbiAgICAgICAgICAgICk6IG51bGxcbiAgICAgICAgICk7XG4gICAgICAgICBpZighYm9hcmQuZ2FtZV9lbmQocGFyc2VJbnQocmVzcG9uc2UuZ2FtZV9zdGF0ZSkpKSB7XG4gICAgICAgICAgICBhaV9tb3ZlKCk7XG4gICAgICAgICB9XG4gICAgICB9KTtcbiAgIH1cblxuICAgICAgZnVuY3Rpb24gYWlfbW92ZSgpIHtcbiAgICAgICAgIGdhcGkuY2xpZW50LmhuZWZhdGFmbC5haV9tb3ZlKHtcbiAgICAgICAgICAgIFwiZ2FtZV9rZXlcIjpLRVlcbiAgICAgICAgIH0pLmV4ZWN1dGUoZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpO1xuICAgICAgICAgICAgYm9hcmQubW92ZShcbiAgICAgICAgICAgICAgIHJlc3BvbnNlLm9yaWdpbl92YWx1ZSxcbiAgICAgICAgICAgICAgIHJlc3BvbnNlLm9yaWdpbixcbiAgICAgICAgICAgICAgIHJlc3BvbnNlLmRlc3RpbmF0aW9uLFxuICAgICAgICAgICAgICAgcmVzcG9uc2UuY2FwdHVyZXMgIT0gXCJbXVwiID9cbiAgICAgICAgICAgICAgIEpTT04ucGFyc2UoXG4gICAgICAgICAgICAgICAgICByZXNwb25zZS5jYXB0dXJlcy5yZXBsYWNlKCcoJywnWycpLnJlcGxhY2UoJyknLCddJylcbiAgICAgICAgICAgICAgICk6IG51bGxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBib2FyZC5nYW1lX2VuZChwYXJzZUludChyZXNwb25zZS5nYW1lX3N0YXRlKSk7XG4gICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7bmV3X2dhbWUsIHBsYXllcl9tb3ZlLCBhaV9tb3ZlLCBsYXN0X3BsYXllcl9nYW1lfTtcbn0pKCk7XG4iLCJ2YXIgZ29vZ2xlX2F1dGggPSAoZnVuY3Rpb24oKXtcblxuICAgY29uc3QgdXJsID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9fYWgvYXBpJztcbiAgIHZhciBzaWduZWRpbiA9IGZhbHNlO1xuXG4gICBmdW5jdGlvbiBsb2FkTW9kdWxlcygpe1xuICAgICAgZ2FwaS5jbGllbnQubG9hZChcbiAgICAgICAgICdvYXV0aDInLFxuICAgICAgICAgJ3YyJ1xuICAgICAgKTtcbiAgICAgIGdhcGkuY2xpZW50LmxvYWQoXG4gICAgICAgICAnaG5lZmF0YWZsJyxcbiAgICAgICAgICd2MScsXG4gICAgICAgICBhZnRlckxvYWRlZCxcbiAgICAgICAgIHVybFxuICAgICAgKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gYWZ0ZXJMb2FkZWQoKSB7XG4gICAgICBzaWduaW4oaW1tZWRpYXRlID0gdHJ1ZSk7XG4gICAgICBzZXRUaW1lb3V0KHByb2ZpbGUuZW5hYmxlTG9naW4oKSwgMjAwMCk7XG5cbiAgIH1cblxuICAgZnVuY3Rpb24gc2lnbmluKGltbWVkaWF0ZSkge1xuICAgICAgZ2FwaS5hdXRoLmF1dGhvcml6ZSh7XG4gICAgICAgICBjbGllbnRfaWQ6ICczMTQyNzIxNjAyNTAtdWNycWc0NGMxb2o5a25scmZhdHF2cWYxYjNwbTk4MTkuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20nLFxuICAgICAgICAgc2NvcGU6ICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9hdXRoL3VzZXJpbmZvLmVtYWlsJyxcbiAgICAgICAgIGltbWVkaWF0ZTogaW1tZWRpYXRlXG4gICAgICB9LCB1c2VyQXV0aGVkKTtcbiAgIH1cblxuICAgZnVuY3Rpb24gaXNBdXRoZWQoKSB7XG4gICAgICByZXR1cm4gc2lnbmVkaW47XG4gICB9XG5cbiAgIGZ1bmN0aW9uIHVzZXJBdXRoZWQobW9kZSkge1xuICAgICAgdmFyIHJlcXVlc3QgPSBnYXBpLmNsaWVudC5vYXV0aDIudXNlcmluZm8uZ2V0KCkuZXhlY3V0ZShmdW5jdGlvbihyZXNwKSB7XG4gICAgICAgICBpZiAoIXJlc3AuY29kZSkge1xuICAgICAgICAgICAgcHJvZmlsZS5zZXRMb2dnZWRJbihyZXNwLnBpY3R1cmUsIHJlc3AubmFtZSk7XG4gICAgICAgICAgICBzaWduZWRpbiA9IHRydWU7XG4gICAgICAgICAgICAvL2dvb2dsZV9hcGlzLm5ld19nYW1lKGdvb2dsZV9hcGlzLmFpX21vdmUpO1xuICAgICAgICAgICAgZ29vZ2xlX2FwaXMubGFzdF9wbGF5ZXJfZ2FtZSgpO1xuICAgICAgICAgLy8gICBnb29nbGVfYXBpcy5haV9tb3ZlKCk7XG4gICAgICAgICAgfVxuICAgICB9KTtcbiAgIH1cbiAgIHJldHVybiB7XG4gICAgICBsb2FkTW9kdWxlczogbG9hZE1vZHVsZXMsXG4gICAgICBpc0F1dGhlZDogaXNBdXRoZWQsXG4gICAgICBzaWduaW46IHNpZ25pblxuICAgfTtcblxufSkoKTtcbiIsInZhciBwcm9maWxlID0gKGZ1bmN0aW9uKCkge1xuICAgdmFyICRsb2dpbiA9ICQoXCIjbG9naW5cIik7XG4gICAvL3ZhciAkcGljdHVyZSA9ICQoXCIjcGljdHVyZVwiKTtcbiAgIHZhciAkbmFtZSA9ICQoXCIjbmFtZVwiKTtcblxuICAgZnVuY3Rpb24gZW5hYmxlTG9naW4oKSB7XG4gICAgICAkbG9naW4ub24oJ2NsaWNrJywgX2xvZ2luQ2xpY2spO1xuICAgICAgY29uc29sZS5sb2coJ2VuYWJsZWQnKTtcbiAgICAgICRsb2dpbi5yZW1vdmVDbGFzcyhcImhpZGRlblwiKTtcbiAgIH1cbiAgIGZ1bmN0aW9uIF9sb2dpbkNsaWNrKCkge1xuICAgICAgY29uc29sZS5sb2coJ2NsaWsnKTtcbiAgICAgIGdvb2dsZV9hdXRoLnNpZ25pbihpbW1lZGlhdGUgPSBmYWxzZSk7XG4gICB9XG4gICBmdW5jdGlvbiBfbG9nb3V0Q2xpY2soKSB7XG4gICAgICAvL3NpbmdpbihpbW1lZGlhdGUgPSBmYWxzZSk7XG4gICB9XG4gICBmdW5jdGlvbiBzZXRMb2dnZWRJbihzcmMsIG5hbWUpIHtcbiAgICAgIGNvbnNvbGUubG9nKG5hbWUpO1xuICAgLy8gICBlbmFibGVMb2dpbigpO1xuICAgLy8gICAkcGljdHVyZS5hdHRyKCdzcmMnLCBzcmMpO1xuICAgICAkbmFtZS5odG1sKG5hbWUpO1xuICAgICAgICAkbmFtZS5yZW1vdmVDbGFzcyhcImhpZGRlblwiKTtcbiAgICAgICRsb2dpbi5hZGRDbGFzcyhcImhpZGRlblwiKTtcbiAgIC8vICAgJGJ0bi5hZGRDbGFzcyhcImFsZXJ0XCIpO1xuICAgLy8vLyAgICRidG4ub2ZmKCdjbGljaycpO1xuICAgLy8gICAkYnRuLm9uKCdjbGljaycsIF9sb2dvdXRDbGljayk7XG4gICB9XG4gICByZXR1cm4ge1xuICAgICAgZW5hYmxlTG9naW46IGVuYWJsZUxvZ2luLFxuICAgICAgc2V0TG9nZ2VkSW46IHNldExvZ2dlZEluXG4gICB9O1xufSkoKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
